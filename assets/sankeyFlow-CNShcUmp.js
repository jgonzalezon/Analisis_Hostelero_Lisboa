import"./index-OLMnQZqJ.js";import{o as at}from"./ordinal-C6iXb5sb.js";import{s as Q,a as lt}from"./init-CttvxIm1.js";import{c as ut}from"./colors-Cc3OSVma.js";const ct=ut("4e79a7f28e2ce1575976b7b259a14fedc949af7aa1ff9da79c755fbab0ab");function J(t,n){let i;if(n===void 0)for(const s of t)s!=null&&(i<s||i===void 0&&s>=s)&&(i=s);else{let s=-1;for(let r of t)(r=n(r,++s,t))!=null&&(i<r||i===void 0&&r>=r)&&(i=r)}return i}function ft(t,n){let i;if(n===void 0)for(const s of t)s!=null&&(i>s||i===void 0&&s>=s)&&(i=s);else{let s=-1;for(let r of t)(r=n(r,++s,t))!=null&&(i>r||i===void 0&&r>=r)&&(i=r)}return i}function G(t,n){let i=0;if(n===void 0)for(let s of t)(s=+s)&&(i+=s);else{let s=-1;for(let r of t)(r=+n(r,++s,t))&&(i+=r)}return i}function dt(t,n){return t.sourceLinks.length?t.depth:n-1}function D(t){return function(){return t}}function K(t,n){return I(t.source,n.source)||t.index-n.index}function X(t,n){return I(t.target,n.target)||t.index-n.index}function I(t,n){return t.y0-n.y0}function V(t){return t.value}function ht(t){return t.index}function pt(t){return t.nodes}function gt(t){return t.links}function Y(t,n){const i=t.get(n);if(!i)throw new Error("missing: "+n);return i}function tt({nodes:t}){for(const n of t){let i=n.y0,s=i;for(const r of n.sourceLinks)r.y0=i+r.width/2,i+=r.width;for(const r of n.targetLinks)r.y1=s+r.width/2,s+=r.width}}function yt(){let t=0,n=0,i=1,s=1,r=24,y=8,f,h=ht,m=dt,x,v,_=pt,b=gt,g=6;function p(){const e={nodes:_.apply(null,arguments),links:b.apply(null,arguments)};return A(e),L(e),T(e),C(e),O(e),tt(e),e}p.update=function(e){return tt(e),e},p.nodeId=function(e){return arguments.length?(h=typeof e=="function"?e:D(e),p):h},p.nodeAlign=function(e){return arguments.length?(m=typeof e=="function"?e:D(e),p):m},p.nodeSort=function(e){return arguments.length?(x=e,p):x},p.nodeWidth=function(e){return arguments.length?(r=+e,p):r},p.nodePadding=function(e){return arguments.length?(y=f=+e,p):y},p.nodes=function(e){return arguments.length?(_=typeof e=="function"?e:D(e),p):_},p.links=function(e){return arguments.length?(b=typeof e=="function"?e:D(e),p):b},p.linkSort=function(e){return arguments.length?(v=e,p):v},p.size=function(e){return arguments.length?(t=n=0,i=+e[0],s=+e[1],p):[i-t,s-n]},p.extent=function(e){return arguments.length?(t=+e[0][0],i=+e[1][0],n=+e[0][1],s=+e[1][1],p):[[t,n],[i,s]]},p.iterations=function(e){return arguments.length?(g=+e,p):g};function A({nodes:e,links:u}){for(const[l,o]of e.entries())o.index=l,o.sourceLinks=[],o.targetLinks=[];const a=new Map(e.map((l,o)=>[h(l,o,e),l]));for(const[l,o]of u.entries()){o.index=l;let{source:d,target:k}=o;typeof d!="object"&&(d=o.source=Y(a,d)),typeof k!="object"&&(k=o.target=Y(a,k)),d.sourceLinks.push(o),k.targetLinks.push(o)}if(v!=null)for(const{sourceLinks:l,targetLinks:o}of e)l.sort(v),o.sort(v)}function L({nodes:e}){for(const u of e)u.value=u.fixedValue===void 0?Math.max(G(u.sourceLinks,V),G(u.targetLinks,V)):u.fixedValue}function T({nodes:e}){const u=e.length;let a=new Set(e),l=new Set,o=0;for(;a.size;){for(const d of a){d.depth=o;for(const{target:k}of d.sourceLinks)l.add(k)}if(++o>u)throw new Error("circular link");a=l,l=new Set}}function C({nodes:e}){const u=e.length;let a=new Set(e),l=new Set,o=0;for(;a.size;){for(const d of a){d.height=o;for(const{source:k}of d.targetLinks)l.add(k)}if(++o>u)throw new Error("circular link");a=l,l=new Set}}function w({nodes:e}){const u=J(e,o=>o.depth)+1,a=(i-t-r)/(u-1),l=new Array(u);for(const o of e){const d=Math.max(0,Math.min(u-1,Math.floor(m.call(null,o,u))));o.layer=d,o.x0=t+d*a,o.x1=o.x0+r,l[d]?l[d].push(o):l[d]=[o]}if(x)for(const o of l)o.sort(x);return l}function N(e){const u=ft(e,a=>(s-n-(a.length-1)*f)/G(a,V));for(const a of e){let l=n;for(const o of a){o.y0=l,o.y1=l+o.value*u,l=o.y1+f;for(const d of o.sourceLinks)d.width=d.value*u}l=(s-l+f)/(a.length+1);for(let o=0;o<a.length;++o){const d=a[o];d.y0+=l*(o+1),d.y1+=l*(o+1)}it(a)}}function O(e){const u=w(e);f=Math.min(y,(s-n)/(J(u,a=>a.length)-1)),N(u);for(let a=0;a<g;++a){const l=Math.pow(.99,a),o=Math.max(1-l,(a+1)/g);c(u,l,o),j(u,l,o)}}function j(e,u,a){for(let l=1,o=e.length;l<o;++l){const d=e[l];for(const k of d){let z=0,S=0;for(const{source:R,value:W}of k.targetLinks){let $=W*(k.layer-R.layer);z+=rt(R,k)*$,S+=$}if(!(S>0))continue;let E=(z/S-k.y0)*u;k.y0+=E,k.y1+=E,F(k)}x===void 0&&d.sort(I),H(d,a)}}function c(e,u,a){for(let l=e.length,o=l-2;o>=0;--o){const d=e[o];for(const k of d){let z=0,S=0;for(const{target:R,value:W}of k.sourceLinks){let $=W*(R.layer-k.layer);z+=st(k,R)*$,S+=$}if(!(S>0))continue;let E=(z/S-k.y0)*u;k.y0+=E,k.y1+=E,F(k)}x===void 0&&d.sort(I),H(d,a)}}function H(e,u){const a=e.length>>1,l=e[a];P(e,l.y0-f,a-1,u),B(e,l.y1+f,a+1,u),P(e,s,e.length-1,u),B(e,n,0,u)}function B(e,u,a,l){for(;a<e.length;++a){const o=e[a],d=(u-o.y0)*l;d>1e-6&&(o.y0+=d,o.y1+=d),u=o.y1+f}}function P(e,u,a,l){for(;a>=0;--a){const o=e[a],d=(o.y1-u)*l;d>1e-6&&(o.y0-=d,o.y1-=d),u=o.y0-f}}function F({sourceLinks:e,targetLinks:u}){if(v===void 0){for(const{source:{sourceLinks:a}}of u)a.sort(X);for(const{target:{targetLinks:a}}of e)a.sort(K)}}function it(e){if(v===void 0)for(const{sourceLinks:u,targetLinks:a}of e)u.sort(X),a.sort(K)}function rt(e,u){let a=e.y0-(e.sourceLinks.length-1)*f/2;for(const{target:l,width:o}of e.sourceLinks){if(l===u)break;a+=o+f}for(const{source:l,width:o}of u.targetLinks){if(l===e)break;a-=o}return a}function st(e,u){let a=u.y0-(u.targetLinks.length-1)*f/2;for(const{source:l,width:o}of u.targetLinks){if(l===e)break;a+=o+f}for(const{target:l,width:o}of e.sourceLinks){if(l===u)break;a-=o}return a}return p}var q=Math.PI,U=2*q,M=1e-6,mt=U-M;function Z(){this._x0=this._y0=this._x1=this._y1=null,this._=""}function ot(){return new Z}Z.prototype=ot.prototype={constructor:Z,moveTo:function(t,n){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)},closePath:function(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")},lineTo:function(t,n){this._+="L"+(this._x1=+t)+","+(this._y1=+n)},quadraticCurveTo:function(t,n,i,s){this._+="Q"+ +t+","+ +n+","+(this._x1=+i)+","+(this._y1=+s)},bezierCurveTo:function(t,n,i,s,r,y){this._+="C"+ +t+","+ +n+","+ +i+","+ +s+","+(this._x1=+r)+","+(this._y1=+y)},arcTo:function(t,n,i,s,r){t=+t,n=+n,i=+i,s=+s,r=+r;var y=this._x1,f=this._y1,h=i-t,m=s-n,x=y-t,v=f-n,_=x*x+v*v;if(r<0)throw new Error("negative radius: "+r);if(this._x1===null)this._+="M"+(this._x1=t)+","+(this._y1=n);else if(_>M)if(!(Math.abs(v*h-m*x)>M)||!r)this._+="L"+(this._x1=t)+","+(this._y1=n);else{var b=i-y,g=s-f,p=h*h+m*m,A=b*b+g*g,L=Math.sqrt(p),T=Math.sqrt(_),C=r*Math.tan((q-Math.acos((p+_-A)/(2*L*T)))/2),w=C/T,N=C/L;Math.abs(w-1)>M&&(this._+="L"+(t+w*x)+","+(n+w*v)),this._+="A"+r+","+r+",0,0,"+ +(v*b>x*g)+","+(this._x1=t+N*h)+","+(this._y1=n+N*m)}},arc:function(t,n,i,s,r,y){t=+t,n=+n,i=+i,y=!!y;var f=i*Math.cos(s),h=i*Math.sin(s),m=t+f,x=n+h,v=1^y,_=y?s-r:r-s;if(i<0)throw new Error("negative radius: "+i);this._x1===null?this._+="M"+m+","+x:(Math.abs(this._x1-m)>M||Math.abs(this._y1-x)>M)&&(this._+="L"+m+","+x),i&&(_<0&&(_=_%U+U),_>mt?this._+="A"+i+","+i+",0,1,"+v+","+(t-f)+","+(n-h)+"A"+i+","+i+",0,1,"+v+","+(this._x1=m)+","+(this._y1=x):_>M&&(this._+="A"+i+","+i+",0,"+ +(_>=q)+","+v+","+(this._x1=t+i*Math.cos(r))+","+(this._y1=n+i*Math.sin(r))))},rect:function(t,n,i,s){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)+"h"+ +i+"v"+ +s+"h"+-i+"Z"},toString:function(){return this._}};function et(t){return function(){return t}}function kt(t){return t[0]}function xt(t){return t[1]}var vt=Array.prototype.slice;function _t(t){return t.source}function bt(t){return t.target}function Lt(t){var n=_t,i=bt,s=kt,r=xt,y=null;function f(){var h,m=vt.call(arguments),x=n.apply(this,m),v=i.apply(this,m);if(y||(y=h=ot()),t(y,+s.apply(this,(m[0]=x,m)),+r.apply(this,m),+s.apply(this,(m[0]=v,m)),+r.apply(this,m)),h)return y=null,h+""||null}return f.source=function(h){return arguments.length?(n=h,f):n},f.target=function(h){return arguments.length?(i=h,f):i},f.x=function(h){return arguments.length?(s=typeof h=="function"?h:et(+h),f):s},f.y=function(h){return arguments.length?(r=typeof h=="function"?h:et(+h),f):r},f.context=function(h){return arguments.length?(y=h??null,f):y},f}function wt(t,n,i,s,r){t.moveTo(n,i),t.bezierCurveTo(n=(n+s)/2,i,n,r,s,r)}function Tt(){return Lt(wt)}function St(t){return[t.source.x1,t.y0]}function Mt(t){return[t.target.x0,t.y1]}function At(){return Tt().source(St).target(Mt)}const Ct=[{id:"market_segment",label:"Segmento de mercado"},{id:"distribution_channel",label:"Canal de distribución"},{id:"deposit_type",label:"Tipo de depósito"},{id:"reservation_status",label:"Estado de reserva"},{id:"meal",label:"Plan de comidas"},{id:"lead_band",label:"Antelación (franjas)"}],nt={Canceled:"Cancelada","Check-Out":"Estancia completada","No-Show":"No presentado",Nuevo:"Cliente nuevo",Repetido:"Cliente repetido",Direct:"Directo",Corporate:"Corporativo","Online TA":"Agencia online","Offline TA/TO":"Agencia/offline",Complementary:"Complementario",Groups:"Grupos",Undefined:"Indefinido",Aviation:"Aerolínea","TA/TO":"Agencia",GDS:"GDS","No Deposit":"Sin depósito",Refundable:"Reembolsable","Non Refund":"No reembolsable",BB:"Solo desayuno",HB:"Media pensión",FB:"Pensión completa",SC:"Sin comidas"},Nt={Total:"Total",Resort:"Resort Hotel",Ciudad:"City Hotel"},Bt=t=>(t=+t)<=7?"0-7 días":t<=30?"8-30 días":t<=90?"31-90 días":"≥ 91 días";function jt(t,n){if(!t)return;if(!(n!=null&&n.length)){t.textContent="Sin datos.";return}n.forEach(g=>{g.lead_band??(g.lead_band=Bt(g.lead_time))});const i=Q(t).html("").append("div").attr("class","sf-wrap"),s=i.append("div").attr("class","sf-chart"),r=i.append("div").attr("class","sf-controls");r.append("label").text("Hotel: ");const y=r.append("select");y.selectAll("option").data(["Total","Resort","Ciudad"]).join("option").attr("value",g=>g).text(g=>g),r.append("label").style("margin-top","0.8rem").text("Cliente: ");const f=r.append("select");f.selectAll("option").data(["Ambos","Nuevo","Repetido"]).join("option").attr("value",g=>g).text(g=>g),r.append("hr"),r.append("p").text("Categoría:");const h=r.append("div").attr("class","sf-cat-box");h.selectAll("button").data(Ct).join("button").text(g=>g.label).attr("data-cat",g=>g.id).on("click",function(g,p){h.selectAll("button").classed("active",!1),Q(this).classed("active",!0),b(p.id,y.property("value"),f.property("value"))}).filter((g,p)=>p===0).classed("active",!0);const m=760,x=440,v=s.append("svg").attr("viewBox",`0 0 ${m} ${x}`).attr("width","100%").attr("height",x),_=at(ct);function b(g,p,A){let L=p==="Total"?n:n.filter(c=>c.hotel===Nt[p]);A==="Nuevo"?L=L.filter(c=>+c.is_repeated_guest==0):A==="Repetido"&&(L=L.filter(c=>+c.is_repeated_guest==1));const T=lt(L,c=>c.length,c=>c[g]??"Sin datos",c=>c.is_repeated_guest?"Repetido":"Nuevo").flatMap(([c,H])=>H.map(([B,P])=>({source:nt[c]??c,target:nt[B]??B,value:P}))),C=Array.from(new Set(T.flatMap(c=>[c.source,c.target]))).map(c=>({name:c})),w=yt().nodeId(c=>c.name).nodeWidth(18).nodePadding(12).extent([[0,0],[m,x]]),{nodes:N,links:O}=w({nodes:C,links:T});v.selectAll("*").remove(),v.append("g").attr("fill","none").attr("stroke-opacity",.45).selectAll("path").data(O).join("path").attr("d",At()).attr("stroke",c=>_(c.source.name)).attr("stroke-width",c=>Math.max(1,c.width)).append("title").text(c=>`${c.source.name} → ${c.target.name}
${c.value} reservas`);const j=v.append("g").selectAll("g").data(N).join("g").attr("transform",c=>`translate(${c.x0},${c.y0})`);j.append("rect").attr("height",c=>c.y1-c.y0).attr("width",w.nodeWidth()).attr("fill",c=>_(c.name)),j.append("text").attr("x",c=>c.x0<m/2?w.nodeWidth()+6:-6).attr("y",c=>(c.y1-c.y0)/2).attr("dy","0.35em").attr("text-anchor",c=>c.x0<m/2?"start":"end").attr("font-size",11).text(c=>`${c.name} (${c.value})`)}y.on("change",()=>{const g=h.select("button.active").attr("data-cat");b(g,y.property("value"),f.property("value"))}),f.on("change",()=>{const g=h.select("button.active").attr("data-cat");b(g,y.property("value"),f.property("value"))}),b("market_segment",y.property("value"),f.property("value"))}export{jt as initSankeyFlow};
